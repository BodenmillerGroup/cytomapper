<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>On disk storage and handling of images • cytomapper</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="On disk storage and handling of images">
<meta property="og:description" content="cytomapper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cytomapper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.15.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/cytomapper.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cytomapper_ondisk.html">On disk storage and handling of images</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BodenmillerGroup/cytomapper/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>On disk storage and handling of images</h1>
                        <h4 data-toc-skip class="author">Nils Eling</h4>
            <address class="author_afil">
      Department for Quantitative Biomedicine, University of
ZurichInstitute for Molecular Health Sciences, ETH
Zurich<br><a class="author_email" href="mailto:#"></a><a href="mailto:nils.eling@dqbm.uzh.ch" class="email">nils.eling@dqbm.uzh.ch</a>
      </address>
                  
            <h4 data-toc-skip class="date">13 December 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/BodenmillerGroup/cytomapper/blob/HEAD/vignettes/cytomapper_ondisk.Rmd" class="external-link"><code>vignettes/cytomapper_ondisk.Rmd</code></a></small>
      <div class="hidden name"><code>cytomapper_ondisk.Rmd</code></div>

    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>To scale the functionality of the <code>cytomapper</code>
      package, images can be stored on disk. For this, images are
      written onto disk as arrays in hdf5 format. Writing and accessing
      these arrays is facilitated by the <code>HDF5Array</code> and
      <code>DelayedArray</code> Bioconductor packages. The functionality
      of <code>cytomapper</code>remains the same, the only change is how
      images are read in. This vignette will give an overview on how to
      work with images stored on disk.</p>
    </div>
    
<div class="section level2">
<h2 id="Introduction">Introduction<a class="anchor" aria-label="anchor" href="#Introduction"></a>
</h2>
<p><em><a href="https://bioconductor.org/packages/3.18/HDF5Array" class="external-link">HDF5Array</a></em>
and <em><a href="https://bioconductor.org/packages/3.18/DelayedArray" class="external-link">DelayedArray</a></em>
are convenient Bioconductor packages to work with arrays “on disk”
instead of “in memory”. The <code>cytomapper</code> package builds upon
these tools to allow storing image data on disk. While this facilitates
the handling of hundreds to thousand of images in parallel, little
changes are experienced from the user perspective. Here, we explain
which <code>cytomapper</code> function are effected by storing images on
disk.</p>
</div>
<div class="section level2">
<h2 id="ReadingData">Reading in data to disk<a class="anchor" aria-label="anchor" href="#ReadingData"></a>
</h2>
<p>The <code>loadImages</code> function takes extra arguments to specify
if images should be stored on disk (<code>on_disk</code>) and where to
store them (<code>h5FilesPath</code>). When images should be stored for
longer than the current R session, the <code>h5FilesPath</code> needs to
be set to a permanent directory. The <code>HDF5Array</code> package
provides the <code>getHDF5DumpDir</code> function, which initialize a
temporary directory, which will be deleted once the session closes. This
is what we will use here for demonstration purposes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/HDF5Array" class="external-link">HDF5Array</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define output directory</span></span>
<span><span class="va">cur_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/HDF5Array/man/dump-management.html" class="external-link">getHDF5DumpDir</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">path.to.images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"cytomapper"</span><span class="op">)</span></span>
<span><span class="va">image.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadImages.html">loadImages</a></span><span class="op">(</span><span class="va">path.to.images</span>, pattern <span class="op">=</span> <span class="st">"mask.tiff"</span>,</span>
<span>                             on_disk <span class="op">=</span> <span class="cn">TRUE</span>, h5FilesPath <span class="op">=</span> <span class="va">cur_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show list</span></span>
<span><span class="va">image.list</span></span></code></pre></div>
<pre><code><span><span class="co">## CytoImageList containing 3 image(s)</span></span>
<span><span class="co">## names(3): E34_mask G01_mask J02_mask </span></span>
<span><span class="co">## Each image contains 1 channel</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scale images</span></span>
<span><span class="va">image.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-manipulation.html">scaleImages</a></span><span class="op">(</span><span class="va">image.list</span>, value <span class="op">=</span> <span class="fl">2</span><span class="op">^</span><span class="fl">16</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">image.list</span><span class="op">$</span><span class="va">E34_mask</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;100 x 100&gt; DelayedMatrix object of type "double":</span></span>
<span><span class="co">##          [,1]   [,2]   [,3] ...  [,99] [,100]</span></span>
<span><span class="co">##   [1,]    824    824    824   .   1265   1265</span></span>
<span><span class="co">##   [2,]    824    824    824   .   1265      0</span></span>
<span><span class="co">##   [3,]    824    824    824   .      0      0</span></span>
<span><span class="co">##   [4,]    824    824    824   .      0   1295</span></span>
<span><span class="co">##   [5,]    824    824    824   .      0   1295</span></span>
<span><span class="co">##    ...      .      .      .   .      .      .</span></span>
<span><span class="co">##  [96,]    835      0    876   .      0      0</span></span>
<span><span class="co">##  [97,]    835      0    876   .      0      0</span></span>
<span><span class="co">##  [98,]    835      0    876   .   1293   1293</span></span>
<span><span class="co">##  [99,]      0      0    876   .   1293   1293</span></span>
<span><span class="co">## [100,]      0      0      0   .   1293   1293</span></span></code></pre>
<p>This function call reads in the .tiff images before writing them as
.h5 files to the indicated directory. It generates a
<code>CytoImageList</code> object that contains <code>HDF5Array</code>
or <code>DelayedArray</code> objects (instead of <code>Image</code>
objects) in each slot, which references the data in the .h5 files. The
name of the array within the .h5 file is automatically set as the
original filename and cannot be changed easily from within R. Writing
the images to disk is slow and therefore less efficient compared to
keeping images in memory. However, when working with hundreds of images
in parallel, all images remain accessible from within the R session if
they are stored on disk. In conclusion: when working with small image
sets it is recommended reading them into memory
(<code>on_disk = FALSE</code>, default), while large image sets should
be written to disk (<code>on_disk = TRUE</code>). When reading in the
same images multiple times, the .h5 files will always be replaced.</p>
<p>Please follow the <a href="https://bioconductor.org/packages/release/bioc/vignettes/cytomapper/inst/doc/cytomapper.html" class="external-link">main
vignette</a> for instructions on how to work with multi-channel images
in R.</p>
</div>
<div class="section level2">
<h2 id="Converting">Converting from on disk to memory and back<a class="anchor" aria-label="anchor" href="#Converting"></a>
</h2>
<p>Existing <code>CytoImageList</code> objects, which contain individual
<code>Image</code> objects in memory can be converted into
<code>CytoImageList</code> objects storing <code>DelayedArray</code> or
<code>HDF5Array</code> objects on disk. For this the following function
calls can be used:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"pancreasImages"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pancreasImages_onDisk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList.html">CytoImageList</a></span><span class="op">(</span><span class="va">pancreasImages</span>,</span>
<span>                                        on_disk <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                        h5FilesPath <span class="op">=</span> <span class="va">cur_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Image object</span></span>
<span><span class="va">pancreasImages</span><span class="op">$</span><span class="va">E34_imc</span></span></code></pre></div>
<pre><code><span><span class="co">## Image </span></span>
<span><span class="co">##   colorMode    : Grayscale </span></span>
<span><span class="co">##   storage.mode : double </span></span>
<span><span class="co">##   dim          : 100 100 5 </span></span>
<span><span class="co">##   frames.total : 5 </span></span>
<span><span class="co">##   frames.render: 5 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## imageData(object)[1:5,1:6,1]</span></span>
<span><span class="co">##           [,1]      [,2]         [,3]      [,4]         [,5]         [,6]</span></span>
<span><span class="co">## [1,] 2.2357869 0.2537275 1.269632e+00 0.9991982 1.990020e+00 0.000000e+00</span></span>
<span><span class="co">## [2,] 2.8855283 1.9900196 2.264642e+00 0.0000000 1.410924e+00 5.654589e-16</span></span>
<span><span class="co">## [3,] 3.4009433 0.9950098 9.950098e-01 2.1800663 4.152935e-17 1.990020e+00</span></span>
<span><span class="co">## [4,] 3.2238317 3.1750760 1.128341e+00 4.4866042 7.371460e-16 0.000000e+00</span></span>
<span><span class="co">## [5,] 0.9987666 1.9900196 2.644036e-15 0.0000000 0.000000e+00 1.523360e+00</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># HDF5Array object</span></span>
<span><span class="va">pancreasImages_onDisk</span><span class="op">$</span><span class="va">E34_imc</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;100 x 100 x 5&gt; HDF5Array object of type "double":</span></span>
<span><span class="co">## ,,H3</span></span>
<span><span class="co">##             [,1]      [,2]      [,3] ...     [,99]    [,100]</span></span>
<span><span class="co">##   [1,] 2.2357869 0.2537275 1.2696325   .  7.265561  1.975094</span></span>
<span><span class="co">##   [2,] 2.8855283 1.9900196 2.2646422   .  2.985029  2.885528</span></span>
<span><span class="co">##    ...         .         .         .   .         .         .</span></span>
<span><span class="co">##  [99,]  2.985029  3.636569 22.976585   . 25.371881 12.045588</span></span>
<span><span class="co">## [100,]  3.061645  2.985029  1.990020   . 13.353615  5.636652</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ,,CDH</span></span>
<span><span class="co">##             [,1]      [,2]      [,3] ...    [,99]   [,100]</span></span>
<span><span class="co">##   [1,]  0.940284 19.651394 43.284626   . 2.704231 0.000000</span></span>
<span><span class="co">##   [2,]  8.393239 29.353861 22.249359   . 7.345311 5.781126</span></span>
<span><span class="co">##    ...         .         .         .   .        .        .</span></span>
<span><span class="co">##  [99,] 0.9897148 7.3378549 0.0000000   . 0.000000 1.667201</span></span>
<span><span class="co">## [100,] 5.8091230 2.2515676 1.9969171   . 4.344125 0.000000</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Seed of HDF5Array object</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DelayedArray/man/showtree.html" class="external-link">seed</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span><span class="op">$</span><span class="va">E34_imc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An object of class "HDF5ArraySeed"</span></span>
<span><span class="co">## Slot "filepath":</span></span>
<span><span class="co">## [1] "/private/var/folders/3s/vfzpb5r51gs6y328rmlgzm7c0000gn/T/Rtmpbnck88/HDF5Array_dump/E34_imc.h5"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "name":</span></span>
<span><span class="co">## [1] "/E34_imc"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "as_sparse":</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "type":</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "dim":</span></span>
<span><span class="co">## [1] 100 100   5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "chunkdim":</span></span>
<span><span class="co">## [1] 100 100   5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "first_val":</span></span>
<span><span class="co">## [1] 2.235787</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Size in memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">pancreasImages</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "1.2 Mb"</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "12.1 Kb"</span></span></code></pre>
<p>Images can also be moved back to in memory representation:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreasImages_inMemory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList.html">CytoImageList</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span>,</span>
<span>                                        on_disk <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare the image data to the original representation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">pancreasImages_inMemory</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">pancreasImages</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="Functionality">Effects on package functionality<a class="anchor" aria-label="anchor" href="#Functionality"></a>
</h2>
<p>While most functions of the <code>cytomapper</code> package natively
support images stored on disk, there are three exceptions: the
<code>normalize</code>, <code>setChannels</code> and
<code>mergeChannels</code> functions.</p>
<p>The <code>normalize</code> function will store the normalized images
as a second dataset in the same .h5 file as the original data.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Size of object in memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "12.1 Kb"</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Size of object on disk in kB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">cur_dir</span>, <span class="st">"/E34_imc.h5"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="st">"size"</span><span class="op">]</span> <span class="op">/</span> <span class="fl">1000</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 148.147</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreasImages_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-manipulation.html">normalize</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DelayedArray/man/showtree.html" class="external-link">seed</a></span><span class="op">(</span><span class="va">pancreasImages_norm</span><span class="op">$</span><span class="va">E34_imc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An object of class "HDF5ArraySeed"</span></span>
<span><span class="co">## Slot "filepath":</span></span>
<span><span class="co">## [1] "/private/var/folders/3s/vfzpb5r51gs6y328rmlgzm7c0000gn/T/Rtmpbnck88/HDF5Array_dump/E34_imc.h5"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "name":</span></span>
<span><span class="co">## [1] "/E34_imc_norm"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "as_sparse":</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "type":</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "dim":</span></span>
<span><span class="co">## [1] 100 100   5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "chunkdim":</span></span>
<span><span class="co">## [1] 100 100   5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "first_val":</span></span>
<span><span class="co">## [1] 0.01235403</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Size of object in memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">pancreasImages_norm</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "12.1 Kb"</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Size of object on disk in kB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">cur_dir</span>, <span class="st">"/E34_imc.h5"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="st">"size"</span><span class="op">]</span> <span class="op">/</span> <span class="fl">1000</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 414.936</span></span></code></pre>
<p>As we can see, the size in memory does not increase when normalizing
images. However, the size on disk increases since a second, normalized
dataset is stored in the .h5 file. The original dataset can be
overwritten by setting <code>overwrite = TRUE</code> to save space on
disk. This will however break the links to the original data in all R
objects. It is therefore recommended leaving the default
<code>overwrite = FALSE</code>. Furthermore, the normalization of images
stored on disk is slower compared to normalizing images in memory since
normalized images need to be written to disk.</p>
<p>The <code>setChannels</code> function replaces the same channels in
all images by a user defined channel. There is no problem with this when
keeping images in memory. However, the <code>DelayedArray</code>
framework stores the replacement value in subassignemt operations in
memory. This means that when using the <code>setChannels</code>
function, the size of the object increases in memory usage:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cur_Images1</span> <span class="op">&lt;-</span> <span class="va">pancreasImages_onDisk</span></span>
<span><span class="va">cur_Images2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-subsetting.html">getChannels</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/CytoImageList-naming.html">channelNames</a></span><span class="op">(</span><span class="va">cur_Images2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"CD99_2"</span></span>
<span></span>
<span><span class="fu">setChannels</span><span class="op">(</span><span class="va">cur_Images1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cur_Images2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">cur_Images1</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "27.7 Kb"</span></span></code></pre>
<p>The <code>mergeChannels</code> function merges multiple user-defined
channels. As this operation creates a completely new image object, one
needs to store the merged channels in a different location:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">channels1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-subsetting.html">getChannels</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">channels2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-subsetting.html">getChannels</a></span><span class="op">(</span><span class="va">pancreasImages_onDisk</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cur_dir</span>, <span class="st">"test"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cur_path_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cur_dir</span>, <span class="st">"test"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">channels3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CytoImageList-subsetting.html">mergeChannels</a></span><span class="op">(</span><span class="va">channels1</span>, <span class="va">channels2</span>,</span>
<span>                            h5FilesPath <span class="op">=</span> <span class="va">cur_path_2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DelayedArray/man/showtree.html" class="external-link">seed</a></span><span class="op">(</span><span class="va">channels3</span><span class="op">$</span><span class="va">E34_imc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An object of class "HDF5ArraySeed"</span></span>
<span><span class="co">## Slot "filepath":</span></span>
<span><span class="co">## [1] "/private/var/folders/3s/vfzpb5r51gs6y328rmlgzm7c0000gn/T/Rtmpbnck88/HDF5Array_dump/test/E34_imc.h5"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "name":</span></span>
<span><span class="co">## [1] "/E34_imc"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "as_sparse":</span></span>
<span><span class="co">## [1] FALSE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "type":</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "dim":</span></span>
<span><span class="co">## [1] 100 100   4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "chunkdim":</span></span>
<span><span class="co">## [1] 100 100   4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Slot "first_val":</span></span>
<span><span class="co">## [1] 2.235787</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="session-info">Session info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<pre><code><span><span class="co">## R version 4.3.2 (2023-10-31)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Monterey 12.6.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] HDF5Array_1.30.0            rhdf5_2.46.1               </span></span>
<span><span class="co">##  [3] DelayedArray_0.28.0         SparseArray_1.2.2          </span></span>
<span><span class="co">##  [5] S4Arrays_1.2.0              abind_1.4-5                </span></span>
<span><span class="co">##  [7] Matrix_1.6-1.1              cytomapper_1.15.2          </span></span>
<span><span class="co">##  [9] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0</span></span>
<span><span class="co">## [11] Biobase_2.62.0              GenomicRanges_1.54.1       </span></span>
<span><span class="co">## [13] GenomeInfoDb_1.38.1         IRanges_2.36.0             </span></span>
<span><span class="co">## [15] S4Vectors_0.40.2            BiocGenerics_0.48.1        </span></span>
<span><span class="co">## [17] MatrixGenerics_1.14.0       matrixStats_1.2.0          </span></span>
<span><span class="co">## [19] EBImage_4.44.0              BiocStyle_2.30.0           </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] bitops_1.0-7             gridExtra_2.3            rlang_1.1.2             </span></span>
<span><span class="co">##  [4] magrittr_2.0.3           svgPanZoom_0.3.4         shinydashboard_0.7.2    </span></span>
<span><span class="co">##  [7] compiler_4.3.2           png_0.1-8                systemfonts_1.0.5       </span></span>
<span><span class="co">## [10] fftwtools_0.9-11         vctrs_0.6.5              stringr_1.5.1           </span></span>
<span><span class="co">## [13] pkgconfig_2.0.3          SpatialExperiment_1.12.0 crayon_1.5.2            </span></span>
<span><span class="co">## [16] fastmap_1.1.1            magick_2.8.1             XVector_0.42.0          </span></span>
<span><span class="co">## [19] ellipsis_0.3.2           utf8_1.2.4               promises_1.2.1          </span></span>
<span><span class="co">## [22] rmarkdown_2.25           ggbeeswarm_0.7.2         ragg_1.2.7              </span></span>
<span><span class="co">## [25] purrr_1.0.2              xfun_0.41                zlibbioc_1.48.0         </span></span>
<span><span class="co">## [28] cachem_1.0.8             jsonlite_1.8.8           later_1.3.2             </span></span>
<span><span class="co">## [31] rhdf5filters_1.14.1      Rhdf5lib_1.24.1          BiocParallel_1.36.0     </span></span>
<span><span class="co">## [34] jpeg_0.1-10              tiff_0.1-12              terra_1.7-55            </span></span>
<span><span class="co">## [37] parallel_4.3.2           R6_2.5.1                 bslib_0.6.1             </span></span>
<span><span class="co">## [40] stringi_1.8.3            RColorBrewer_1.1-3       jquerylib_0.1.4         </span></span>
<span><span class="co">## [43] Rcpp_1.0.11              bookdown_0.37            knitr_1.45              </span></span>
<span><span class="co">## [46] httpuv_1.6.13            nnls_1.5                 tidyselect_1.2.0        </span></span>
<span><span class="co">## [49] viridis_0.6.4            yaml_2.3.8               codetools_0.2-19        </span></span>
<span><span class="co">## [52] lattice_0.21-9           tibble_3.2.1             shiny_1.8.0             </span></span>
<span><span class="co">## [55] evaluate_0.23            desc_1.4.3               pillar_1.9.0            </span></span>
<span><span class="co">## [58] BiocManager_1.30.22      generics_0.1.3           sp_2.1-2                </span></span>
<span><span class="co">## [61] RCurl_1.98-1.13          ggplot2_3.4.4            munsell_0.5.0           </span></span>
<span><span class="co">## [64] scales_1.3.0             xtable_1.8-4             glue_1.6.2              </span></span>
<span><span class="co">## [67] tools_4.3.2              locfit_1.5-9.8           fs_1.6.3                </span></span>
<span><span class="co">## [70] grid_4.3.2               colorspace_2.1-0         GenomeInfoDbData_1.2.11 </span></span>
<span><span class="co">## [73] raster_3.6-26            beeswarm_0.4.0           vipor_0.4.5             </span></span>
<span><span class="co">## [76] cli_3.6.2                textshaping_0.3.7        fansi_1.0.6             </span></span>
<span><span class="co">## [79] viridisLite_0.4.2        svglite_2.1.3            dplyr_1.1.4             </span></span>
<span><span class="co">## [82] gtable_0.3.4             sass_0.4.8               digest_0.6.33           </span></span>
<span><span class="co">## [85] rjson_0.2.21             htmlwidgets_1.6.4        memoise_2.0.1           </span></span>
<span><span class="co">## [88] htmltools_0.5.7          pkgdown_2.0.7            lifecycle_1.0.4         </span></span>
<span><span class="co">## [91] mime_0.12</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nils Eling, Nicolas Damond, Lasse Meyer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
